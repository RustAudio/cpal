name: Sanitizers

on:
  push:
    branches: [master]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "LICENSE*"
      - ".gitignore"
  pull_request:
    branches: [master]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "LICENSE*"
      - ".gitignore"
  workflow_dispatch:

jobs:
  sanitizers:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macOS-latest
            target: aarch64-apple-darwin
            sanitizer: address
            name: ASAN-macOS

          - os: macOS-latest
            target: aarch64-apple-darwin
            sanitizer: thread
            name: TSAN-macOS

          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            sanitizer: address
            name: ASAN-Linux

          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            sanitizer: thread
            name: TSAN-Linux

    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v5

      - name: Cache Linux audio packages
        if: runner.os == 'Linux'
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: libasound2-dev libjack-jackd2-dev libjack-jackd2-0 libdbus-1-dev

      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: brew install llvm

      - name: Install nightly Rust with rust-src
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rust-src

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.name }}

      - name: Run tests with sanitizer
        env:
          RUSTFLAGS: -Zsanitizer=${{ matrix.sanitizer }}
          RUSTDOCFLAGS: -Zsanitizer=${{ matrix.sanitizer }}
          TSAN_OPTIONS: ${{ matrix.sanitizer == 'thread' && 'second_deadlock_stack=1' || '' }}
        run: |
          cargo +nightly test \
            -Zbuild-std \
            --target ${{ matrix.target }} \
            --lib \
            --verbose

      - name: Upload sanitizer logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-logs
          path: |
            *.log.*
            /tmp/asan.*
            /tmp/tsan.*
          if-no-files-found: ignore
